Load required libraries
```{R}
library(tidyverse)
library(ggplot2)
library(DT)
library(glmmTMB)
```


I. Reading the data
```{R}
dmd_apnoea <- read_table("dmd-apnoea.txt")
View(dmd_apnoea)
```


II. Exploratory Data Analysis
1. Verify that you can reproduce Figure 1 of the paper. Make a version of this plot that is easier to read, perhaps by producing separate plots for different subtype/hypoventilation status.

Reproduce the original plot:
```{R}
# Plot the data: Scatter plot of age versus AHI
dmd_apnoea %>%
  filter(hypo != -99) %>% 
  mutate(hypo = as.factor(hypo)) %>%
  ggplot(
    aes(x = ageyears,
        y = ahi,
        shape = type,
        colour = hypo)) +
  geom_point(size = 1, stroke = 2) +
  labs(title = "Figure 1: Scatter plot of age versus AHI",
       x = "Age (Yrs)",
       y = "AHI (Events/hr)") +
  # shape: 5 for BMD, 0 for CMD, 1 for DM, 4 for DMD, 3 for LGMD
  scale_shape_manual(values = c(5, 0, 1, 4, 3)) +
  # colour: blue for 0, red for 1
  scale_colour_manual(values = c("cornflowerblue", "brown3")) +
  theme_minimal(base_size = 15) +
  theme(aspect.ratio=3/4)
```

Easier to read version:
1) Separate plots for different subtypes
```{R}
# Plot the data: Scatter plots of age versus AHI
# Separate plots for BMD, CMD, DM, DMD, LGMD
dmd_apnoea %>%
  filter(hypo != -99) %>% 
  mutate(hypo = as.factor(hypo)) %>%
  ggplot(
    aes(x = ageyears,
        y = ahi,
        shape = type,
        colour = hypo)) +
  geom_point(size = 1, stroke = 1) +
  labs(title = "Scatter plot of age versus AHI\nfor different subtypes",
       x = "Age (Yrs)",
       y = "AHI (Events/hr)") +
  facet_wrap(~type) +
  # shape: 5 for BMD, 0 for CMD, 1 for DM, 4 for DMD, 3 for LGMD
  scale_shape_manual(values = c(5, 0, 1, 4, 3)) +
  # colour: blue for 0, red for 1
  scale_colour_manual(values = c("cornflowerblue", "brown3")) +
  theme_minimal(base_size = 14) +
  theme(aspect.ratio=3/4)
```

2) Separate plots for different hypoventilation status
```{R}
# Plot the data: Scatter plots of age versus AHI
# separate plots for hypo = 1 and hypo = 0
dmd_apnoea %>%
  filter(hypo != -99) %>% 
  mutate(hypo = as.factor(hypo)) %>%
  ggplot(
    aes(x = ageyears,
        y = ahi,
        shape = type,
        colour = hypo)) +
  geom_point(size = 1, stroke = 1) +
  labs(title = "Scatter plot of age versus AHI\nfor different hypoventilation status",
       x = "Age (Yrs)",
       y = "AHI (Events/hr)") +
  facet_wrap(~hypo) +
  # shape: 5 for BMD, 0 for CMD, 1 for DM, 4 for DMD, 3 for LGMD
  scale_shape_manual(values = c(5, 0, 1, 4, 3)) +
  # colour: blue for 0, red for 1
  scale_colour_manual(values = c("cornflowerblue", "brown3")) +
  theme_minimal(base_size = 14) +
  theme(aspect.ratio=3/4)
```

3) Separate plots for different subtypes and hypoventilation status
```{R}
# Plot the data: Scatter plots of age versus AHI
# separate plots for hypo = 1 and hypo = 0
dmd_apnoea %>%
  filter(hypo != -99) %>% 
  mutate(hypo = as.factor(hypo)) %>%
  ggplot(
    aes(x = ageyears,
        y = ahi,
        shape = type,
        colour = hypo)) +
  geom_point(size = 1, stroke = 1) +
  labs(title = "Scatter plot of age versus AHI\nfor different subtypes and hypoventilation status",
       x = "Age (Yrs)",
       y = "AHI (Events/hr)") +
  facet_grid(type ~ hypo) +
  # shape: 5 for BMD, 0 for CMD, 1 for DM, 4 for DMD, 3 for LGMD
  scale_shape_manual(values = c(5, 0, 1, 4, 3)) +
  # colour: blue for 0, red for 1
  scale_colour_manual(values = c("cornflowerblue", "brown3")) +
  theme_minimal(base_size = 11) +
  theme(aspect.ratio=3/4)
```

2. Produce tables showing the mean and standard deviation of AHI for each disease subtype.
```{R}
# Table of mean and standard deviation of AHI for each disease subtype
dmd_apnoea %>%
  group_by(type) %>%
  summarise(mean_AHI = sprintf("%.2f", mean(ahi, na.rm = TRUE)),
            sd_ahi = sprintf("%.2f", sd(ahi, na.rm = TRUE))) %>%
  datatable()
```

3. Make a histogram of the distribution of AHI
```{R}
# Histogram of AHI
dmd_apnoea %>%
  ggplot(aes(x = ahi)) +
  geom_histogram(binwidth = 5, fill = "cornflowerblue", colour = "black") +
  labs(title = "Histogram of AHI",
       x = "AHI (Events/hr)",
       y = "Frequency") +
  theme_minimal(base_size = 15) +
  theme(aspect.ratio=3/4)
```


III. Linear model for AHI
4. Fit a linear model ahi ~ ageyears + type and evaluate the residual plots. Comment on your conclusions.
```{R}
# Fit a linear model ahi ~ ageyears + type
lm <- lm(ahi ~ ageyears + type, data = dmd_apnoea)
summary(lm)

# Residuals:
#     Min      1Q  Median      3Q     Max
# -16.512  -5.076  -1.050   3.543  41.347

# Coefficients:
#              Estimate Std. Error t value Pr(>|t|)
# (Intercept)  16.49514    3.47593   4.746 7.09e-06 ***
# ageyears      0.15040    0.05326   2.824 0.005745 **
# typeCMD     -13.45609    4.20457  -3.200 0.001850 **
# typeDM      -13.18742    3.37949  -3.902 0.000175 ***
# typeLGMD    -14.80572    3.82503  -3.871 0.000196 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# Residual standard error: 8.157 on 98 degrees of freedom
# Multiple R-squared:  0.2253,    Adjusted R-squared:  0.1858
# F-statistic:   5.7 on 5 and 98 DF,  p-value: 0.0001171


# Residual plots
par(mfrow = c(2, 2), pin = c(3, 2.25))
# 3:4 aspect ratio
plot(lm)

```
Comment on your conclusions:

Goodness of fit with signiticant t and F but low R-squared:
- t-values for all predicters are significant within 1% level.
- Adjusted R-squared is low.
- F-statistic is significant within 0.1% level.
Suggesting that, while the predictors are relevant, there may be nonlinear relationships, missing predictors, or interactions between predictors that are not captured by the model.

Residual plots:
- Residual vs Fitted Values plot: The non-horizontal smoother line suggests the possible presence of non-linear relationships between predictors (age and type) and the response variable (AHI) that are omitted by the model.
- Q-Q plot of standard residuals: The residuals exhibit tails on the same side on the line, indecating skewness in the residuals.
- Scale-Location plot: The upward trend in the smoother line indicates heteroscedasticity, violating the homoscedasticity assumption of linear regression.
- Residuals vs Leverage plot: While a few points display high leverage or high residuals, none exhibit high Cook's distance, suggesting there are no influential points in the dataset.


5. Assuming a linear model is reasonable, see whether there is evidence for differences in relationship beween ahi and age in different diagnoses.
```{R}
# Fit a linear model with interaction term: ahi ~ ageyears * type
lm_inter <- lm(ahi ~ ageyears * type, data = dmd_apnoea)
summary(lm_inter)

# Residuals:
#     Min      1Q  Median      3Q     Max
# -13.964  -4.630  -1.235   3.198  41.267

# Coefficients:
#                    Estimate Std. Error t value Pr(>|t|)  
# (Intercept)        11.68235    5.01843   2.328   0.0221 *
# ageyears            0.31006    0.13103   2.366   0.0200 *
# typeCMD           -13.57024   10.98772  -1.235   0.2199
# typeDM             -7.33746    5.44509  -1.348   0.1810
# typeDMD            -9.26606    6.41475  -1.444   0.1519
# typeLGMD           -8.19279    6.56712  -1.248   0.2153
# ageyears:typeCMD    0.20380    0.70467   0.289   0.7731
# ageyears:typeDM    -0.20342    0.14794  -1.375   0.1724
# ageyears:typeDMD    0.07569    0.29999   0.252   0.8014
# ageyears:typeLGMD  -0.22281    0.18137  -1.228   0.2223
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# Residual standard error: 8.191 on 94 degrees of freedom
# Multiple R-squared:  0.2507,    Adjusted R-squared:  0.1789 
# F-statistic: 3.494 on 9 and 94 DF,  p-value: 0.0009178


# ANOVA test for interaction term
anova(lm, lm_inter)

#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1     98 6520.5
# 2     94 6307.1  4    213.39 0.7951 0.5313
```
Goodness of fit and ANOVA test not significant:
- t-values for the ageyears:type interaction terms are not significant.
- Adjusted R-squared for the model with interaction terms is lower than the model without interaction terms.
- (Ignore Multiple R-squared as it increases with the addition of more predictors, even if they are not significant.)
- ANOVA test F-statistic is not significant.
Suggesting that there is no evidence for differences in the relationship between AHI and age in different diagnoses.


IV. Generalized linear model for AHI
6. Group together observations into approx 5-year age groups. Make a plot of the group means against group variances, using a log scales for both axes. By fitting a suitable linear model to the grouped data, explain why the data are consistent with a variance function of the form V (µ) = µ^2.
```{R}
# Group data into 5-year age groups & Calculate group means and variances
dmd_apnoea_grouped <- dmd_apnoea %>%
  mutate(age_group = floor(ageyears / 5) * 5) %>%
  group_by(age_group) %>%
  summarise(
    mean_ahi = mean(ahi),
    var_ahi = var(ahi)
  )

# Plot group means vs. group variances
dmd_apnoea_grouped %>%
  ggplot(aes(x = mean_ahi, y = var_ahi)) +
  geom_point() +
  scale_x_log10() + scale_y_log10() +
  geom_smooth(method = "lm", colour = "darkred") +
  labs(title = "Log Group Means vs. Log Group Variances",
       x = "Log Group Mean AHI",
       y = "Log Group Variance AHI") +
  theme_minimal(base_size = 15) +
  theme(aspect.ratio=3/4)

# Fit a linear model to the grouped data
lm_grouped <- lm(log(var_ahi) ~ log(mean_ahi), data = dmd_apnoea_grouped)
summary(lm_grouped)

# Residuals:
#     Min      1Q  Median      3Q     Max
# -6.2094 -0.0483  0.5589  0.9554  1.5640

# Coefficients:
#               Estimate Std. Error t value Pr(>|t|)  
# (Intercept)     -1.134      2.359  -0.481   0.6410
# log(mean_ahi)    2.122      1.071   1.980   0.0758 .
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# Residual standard error: 2.185 on 10 degrees of freedom
# Multiple R-squared:  0.2817,    Adjusted R-squared:  0.2099 
# F-statistic: 3.922 on 1 and 10 DF,  p-value: 0.07581

```
Goodness of fit not ideal:
- t-value for the log(mean_ahi) coefficient is not significant / only significant within 10% level.
- Adjusted R-squared is not high.
- F-statistic is not significant / only significant within 10% level.
Suggesting the model may not be the best fit for the data
If the data is consistent with the model, it suggests that V(μ) = e^(-1.13) * μ^2.12.

Try to improve the goodness of fit by merging the last age group with the previous one, as it has only 3 observations and is an outlier.
```{R}
# Group data into 5-year age groups & Calculate group means and variances
dmd_apnoea_grouped_merged <- dmd_apnoea %>%
  mutate(age_group = ifelse(ageyears < 55, floor(ageyears / 5) * 5, 55)) %>%
  group_by(age_group) %>%
  summarise(
    mean_ahi = mean(ahi),
    var_ahi = var(ahi)
  )

# Plot group means vs. group variances
dmd_apnoea_grouped_merged %>%
  ggplot(aes(x = mean_ahi, y = var_ahi)) +
  geom_point() +
  scale_x_log10() + scale_y_log10() +
  geom_smooth(method = "lm", colour = "cornflowerblue") +
  labs(title = "Log Group Means vs. Log Group Variances",
       x = "Log Group Mean AHI",
       y = "Log Group Variance AHI") +
  theme_minimal(base_size = 15) +
  theme(aspect.ratio=3/4)

# Fit a linear model to the grouped data
lm_grouped_merged <- lm(log(var_ahi) ~ log(mean_ahi), data = dmd_apnoea_grouped_merged)
summary(lm_grouped_merged)

# Residuals:
#     Min      1Q  Median      3Q     Max 
# -1.3750 -0.2411  0.1453  0.3711  0.8405

# Coefficients:
#               Estimate Std. Error t value Pr(>|t|)
# (Intercept)     0.5795     0.8225   0.705  0.49890
# log(mean_ahi)   1.5926     0.3741   4.257  0.00212 **
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# Residual standard error: 0.7192 on 9 degrees of freedom
# Multiple R-squared:  0.6682,    Adjusted R-squared:  0.6313
# F-statistic: 18.12 on 1 and 9 DF,  p-value: 0.002121

```
Goodness of fit improved after merging the last two age group:
- t-value for the log(mean_ahi) coefficient is more significant within 1% level.
- Adjusted R-squared is higher.
- F-statistic is more significant within 1% level.
Suggesting the model is a better fit for the data, V(μ) = e^(0.58) * μ^1.59 ≈ μ^2.
From the plot [insert plot], we can oberve that e^(0.58) * μ^1.59 is closer to μ^2 than e^(-1.13) * μ^2.12, in the range of group means and variances in the data, further supporting the hypothesis that the model with merged age grouped.


7. (*) Explore models for the relationship between age and AHI that better respect the properties of the data. Give a bootstrap confidence interval for the age effect in your preferred model. You may also wish to investigate e.g. differences by sex.
    The mean-variance relationship suggests using a Gamma GLM, although this is incompatible with the presence of zeros in the data. One approach could be to fit a quasi-GLM model for AHI, using only non-zero AHI observations. A hurdle model is another possibility.

Model: Gamma GLM could be appropriate as it aligns with the variance being proportional to mean squared for AHI.
- Data : Only use positive AHI observations, as non-positive values of AHI are not allowed for Gamma distribution.
- Link choice: While the inverse link is canonical for the Gamma distribution, I would choose the log link as it ensures predicted values remain positive and are easier to interpret.
```{R}
# Fit a Gamma GLM model for positive AHI
dmd_apnoea_pos <- dmd_apnoea %>% filter(ahi > 0)

gamma_log <- glm(ahi ~ ageyears, data = dmd_apnoea_pos, family = Gamma(link = "log"))
summary(gamma_log)

# Coefficients:
#             Estimate Std. Error t value Pr(>|t|)
# (Intercept)  1.69676    0.17099   9.923  < 2e-16 ***
# ageyears     0.01838    0.00651   2.823  0.00578 **
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# (Dispersion parameter for Gamma family taken to be 1.153416)

#     Null deviance: 127.83  on 98  degrees of freedom
# Residual deviance: 118.97  on 97  degrees of freedom
# AIC: 615.35

# Number of Fisher Scoring iterations: 7
```
Goodness of fit:
- t-value for the ageyears coefficient is significant within 1% level.
- Residual deviance is slightly lower than the null deviance.
- AIC is high.
Suggesting that, while the age predictor is relevant, the model may not be the best fit for the data.
This may be due to the incompatibility of the Gamma GLM with the presence of zeros in the data.

Try to improve the model by fitting a quasi-GLM model.
Model: Quasi-GLM could be appropriate as it allows negative values.
- Data: Only use positive AHI observations.
```{R}
quasigamma_log <- glm(ahi ~ ageyears, data = dmd_apnoea, family = quasi(link = "log", variance = "mu^2"))
summary(quasigamma_log)

# Coefficients:
#             Estimate Std. Error t value Pr(>|t|)
# (Intercept) 1.641435   0.176552   9.297 2.92e-15 ***
# ageyears    0.018675   0.006794   2.749  0.00707 **
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# (Dispersion parameter for quasi family taken to be 1.263555)

#     Null deviance: 138.74  on 103  degrees of freedom
# Residual deviance: 129.16  on 102  degrees of freedom
# AIC: NA

# Number of Fisher Scoring iterations: 7

```
Goodness of fit:
- t-value for the ageyears coefficient is slightly less significant than Gamma GLM.
- Residual deviance is slightly lower than the null deviance, but both slightly higher than those of Gamma GLM.
Suggesting the quasiGamma GLM does not fit better than Gamma GLM.
But the model more accurately reflecting the data since it includes the full dataset.

Model: Hurdle Gamma GLM.
```{R}
logit_ahi <- ifelse(dmd_apnoea$ahi > 0, 1, 0)
dmd_apnoea_logit <- data.frame(dmd_apnoea, logit_ahi)
hurdle_gamma1 <- glm(logit_ahi ~ ageyears, data = dmd_apnoea_logit, family = binomial)
hurdle_gamma2 <- glm(ahi ~ ageyears, data = subset(dmd_apnoea, ahi > 0), family = Gamma(link = "log"))
summary(hurdle_gamma1)

# Coefficients:
#             Estimate Std. Error z value Pr(>|z|)
# (Intercept) 2.870588   0.732452   3.919 8.89e-05 ***
# ageyears    0.005864   0.030092   0.195    0.846
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# (Dispersion parameter for binomial family taken to be 1)

#     Null deviance: 40.105  on 103  degrees of freedom
# Residual deviance: 40.066  on 102  degrees of freedom
# AIC: 44.066

summary(hurdle_gamma2)
# same as Gamma GLM
```

Model: Zero-inflated Gamma GLM.
```{R}
zigamma_log <- glmmTMB(ahi ~ ageyears, data = dmd_apnoea, family = ziGamma(link = "log"), ziformula = ~ ageyears)
summary(zigamma_log)

# Family: Gamma  ( log )
# Formula:          ahi ~ ageyears
# Zero inflation:       ~ageyears
# Data: dmd_apnoea

#      AIC      BIC   logLik deviance df.resid
#    658.1    671.3   -324.0    648.1       99


# Dispersion estimate for Gamma family (sigma^2): 1.04

# Conditional model:
#             Estimate Std. Error z value Pr(>|z|)
# (Intercept) 1.696759   0.170189   9.970  < 2e-16 ***
# ageyears    0.018377   0.006675   2.753  0.00591 **
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# Zero-inflation model:
#              Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -2.870588   0.732450  -3.919 8.89e-05 ***
# ageyears    -0.005864   0.030092  -0.195    0.846
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

V. Binomial GLM for severe sleep apnoea.
8. A patient is defined to have severe sleep apnoea if their AHI is greater than 10 events per hour.
    Determine the effect on the odds of sleep apnoea of a 10 year increase in age, with a confidence interval.